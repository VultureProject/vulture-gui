#This file is part of Vulture OS.
#

########################## WARNING ###############################
# Don't edit this file, it is automatically generated by Vulture #
########################## WARNING ###############################


frontend Workflow_{{conf.id}}
    bind unix@/var/sockets/haproxy/workflow_{{conf.id}}.sock accept-proxy
    mode {{ conf.mode }}


    ### ACL definitions ###
    {% if conf.access_controls_list -%}
    {% for acl in conf.access_controls_list %}
    {{ acl }}
    {% endfor %}
    {% endif -%}

    {%- if conf.mode == "http" and conf.authentication %}
    ### Headers ACLs ###
    acl header_has_authent req.hdr(Authorization) -m found
    acl header_has_authent req.hdr(X-Vlt-Token) -m found
    acl request_has_authent req.hdr(Authorization) -m found
    acl request_has_authent req.hdr(X-Vlt-Token) -m found
    acl request_has_authent req.cook({{ global_config.portal_cookie_name }}) -m found

    ### Workflow ACLs ###
    # avoid redirections to portal on those paths
    acl workflow_{{conf.id}}_dir_auth path -i -m beg {{ conf.public_dir }}
    acl workflow_{{conf.id}}_dir_auth path -i -m beg /templates/
    acl workflow_{{conf.id}}_dir_auth path -i -m beg {{ conf.public_dir }}{{global_config.public_token}}/
    # If user not on conf.public_dir and is not authenticated, redirect to main url + redirect_url GET param
    acl auth_redirect_{{conf.id}} path -i -m beg /templates/
    acl auth_redirect_{{conf.id}} path -i -m beg {{ conf.public_dir }}{{global_config.public_token}}/
    {% for repo in conf.authentication.openid_repos -%}
    acl auth_redirect_{{conf.id}} path /oauth2/callback/{{repo.id}}
    acl auth_redirect_{{conf.id}} path /oauth2/start/{{repo.id}}
    {% endfor -%}
    {% endif %}

    ### ACL rules ###
    {%- if conf.access_controls_deny|length -%}
    {% for acl in conf.access_controls_deny -%}
    {# if acl.deny -> deny or redirect if the ACL matches #}
    {%- if acl.deny %}
    {% for condition in acl.conditions %}
    {%- if conf.mode == "http" %}
    http-request deny if
    {%- elif conf.mode == "tcp" %}
    tcp-request content reject if
    {%- endif %} {{ condition }}
    {%- endfor %} {# for condition in acl.conditions #}
    {# if not acl.deny -> deny or redirect unless (if not) the ACL matches #}
    {%- else %}
    {%- if conf.mode == "http" %}
    http-request deny unless
    {%- elif conf.mode == "tcp" %}
    tcp-request content reject unless
    {%- endif %} {{ acl.conditions | join(" || ") }}
    {%- endif %}
    {%- endfor %} {# for acl in conf.access_controls_deny #}
    {% endif %} {# if conf.access_controls_deny|length #}
    {%- if conf.access_controls_302|length %}
    ### 302 redirects ###
    {%- for acl in conf.access_controls_302 %}
    {# if acl.redirect -> redirect or redirect if the ACL matches #}
    {%- if acl.redirect %}
    {%- for condition in acl.conditions %}
    http-request redirect location {{ acl.redirect_url }} code 302 if {{ condition }}
    {%- endfor %}
    {# if not acl.redirect -> redirect or redirect unless (if not) the ACL matches #}
    {%- else %}
    http-request redirect location {{ acl.redirect_url }} code 302 unless {{ acl.conditions | join(" || ") }}
    {%- endif %}
    {%- endfor %}
    {%- endif %}
    {%- if conf.access_controls_301|length %}
    ### 301 redirects ###
    {% for acl in conf.access_controls_301 %}
    {# if acl.redirect -> redirect or redirect if the ACL matches #}
    {%- if acl.redirect %}
    {% for condition in acl.conditions %}
    http-request redirect location {{ acl.redirect_url }} code 301 if {{ condition }}
    {%- endfor %}
    {# if not acl.redirect -> redirect or redirect unless (if not) the ACL matches #}
    {%- else %}
    http-request redirect location {{ acl.redirect_url }} code 301 unless {{ acl.conditions | join(" || ") }}
    {%- endif %}
    {%- endfor %}
    {%- endif %}


    {%- if conf.authentication %}
    ### AUTH ###
    {% for repo in conf.authentication.openid_repos -%}
    # Handle /oauth2/start and /oauth2/callback for {{repo.name}}
    {#- if fqdn and path == "{{w.path}}/oauth2/callback/{{repo.id_alea}}": #}
    {#- use portal + set url = /oauth2/callback/{{repo.id}} #}
    http-request set-var(req.use_portal) bool(true) if { path -i -m beg {{conf.public_dir}}oauth2/callback/{{repo.id_alea}} }
    http-request set-path /oauth2/callback/{{repo.id}} if { path -i -m beg {{conf.public_dir}}oauth2/callback/{{repo.id_alea}} }
    {#- if fqdn and path == "{{w.path}}/oauth2/start?r={{repo.id}}": #}
    {#- use portal + set url = /oauth2/start/{{repo.id}} #}
    http-request set-var(req.use_portal) bool(true) if { path -i -m beg {{conf.public_dir}}oauth2/start } { url_param("repo") eq {{repo.id}} }
    http-request set-path /oauth2/start/{{repo.id}} if { path -i -m beg {{conf.public_dir}}oauth2/start } { url_param("repo") eq {{repo.id}} }
    {% endfor -%}
    # Handle OAuth2 responder endpoints
    {% if conf.authentication.enable_oauth -%}
    http-request set-var(req.use_portal) bool(true) if { path {{conf.public_dir}}oauth2/userinfo }
    http-request replace-path {{conf.public_dir}}(.*) /\1 if { path {{conf.public_dir}}oauth2/userinfo }
    {% endif -%}

    # Handle disconnect
    http-request set-var(req.use_portal) bool(true) if { url_reg {{conf.disconnect_url}} }
    http-request set-path /vulture_disconnect if { url_reg {{conf.disconnect_url}} }
    # Handle self service
    http-request set-var(req.use_portal) bool(true) if { path -i -m beg {{conf.public_dir}}{{global_config.public_token}}/self }
    http-request replace-path {{conf.public_dir}}{{global_config.public_token}}/(.*) /\1 if { path -i -m beg {{conf.public_dir}}{{global_config.public_token}}/self }

    ### ACCESS ###
    # Workflow {{conf.name}}

    {% if conf.check_jwt -%}
    # get header part of the JWT
    http-request set-var(txn.alg) http_auth_bearer,jwt_header_query('$.alg')

    # get payload part of the JWT
    http-request set-var(txn.iss) http_auth_bearer,jwt_payload_query('$.iss')
    http-request set-var(txn.aud) http_auth_bearer,jwt_payload_query('$.aud')
    http-request set-var(txn.exp) http_auth_bearer,jwt_payload_query('$.exp','int')
    http-request set-var(txn.now) date()
    {%- endif %}

    {% for repo in conf.authentication.openid_repos if repo.enable_jwt -%}
    # Validate JWT for repo {{repo.name}}
    http-request set-var(txn.valid_jwt) bool(true) if { var(txn.alg) -m str "{{repo.jwt_signature_type}}" } { var(txn.iss) -m str "{{repo.provider_url}}" } {% if repo.jwt_validate_audience -%} { var(txn.aud) -m str "{{conf.redirect_uri}}" } {%- endif %} { http_auth_bearer,jwt_verify("{{repo.jwt_signature_type}}","{{repo.jwt_key if repo.jwt_signature_type in ("HS256", "HS384", "HS512") else repo.get_jwt_key_filename()}}") -m int 1 } { var(txn.exp),sub(txn.now) -m int gt 0 }
    {% endfor -%} {# for repo in conf.authentication.openid_repos if repo.enable_jwt #}

    # Check session with LUA
    http-request lua.check_session_from_cookie "{{ global_config.portal_cookie_name }}" "{{conf.id}}" {{conf.authentication.auth_timeout}} if { req.cook({{ global_config.portal_cookie_name }}) -m found } !{ var(txn.valid_jwt) -m bool }
    http-request lua.check_session_from_header "Authorization" "{{conf.openid_client_ids | join(';')}}" 0 if { req.hdr(Authorization) -m found } !{ var(txn.valid_jwt) -m bool }
    http-request lua.check_session_from_header "X-Vlt-Token" "{{conf.openid_client_ids | join(';')}}" 0 if { req.hdr(X-Vlt-Token) -m found } !{ var(txn.valid_jwt) -m bool }
    # Return gateway timeout in case of authentication check failure
    http-request deny deny_status 504 if request_has_authent !{ var(req.session.check_ok) -m found } !{ var(txn.valid_jwt) -m bool }
    # Deny access in case of header authentication failure (through 'Authentication' or 'X-Vlt-Token' headers)
    http-request deny deny_status 401 hdr WWW-Authenticate "Bearer realm=\"{{conf.fqdn}}\"" if header_has_authent !{ var(req.session.authorized) -m bool } !{ var(req.use_portal) -m bool } !auth_redirect_{{conf.id}} !{ var(txn.valid_jwt) -m bool }
    {%- endif %} {# if conf.authentication #}


    ################
    ### BACKENDS ###
    ################
    {%- if conf.mode == "http" and conf.authentication %}
    # Portals
    use_backend portal_{{conf.id}} if !{ var(req.session.authorized) -m bool } workflow_{{conf.id}}_dir_auth !{ var(txn.valid_jwt) -m bool }
    use_backend portal_{{conf.id}} if { var(req.use_portal) -m bool }
    {%- endif %}

    # Backends
    {% if conf.mode == "tcp" %}default{% else %}use{% endif -%}
    _backend {{ conf.backend.name }}
        {%- if conf.mode == "http" and conf.authentication %} if { var(req.session.authorized) -m bool } || { var(txn.valid_jwt) -m bool }{% endif %}

{% if conf.mode == "http" and conf.authentication %}
backend portal_{{ conf.id }}
    timeout connect 2s
    timeout server 20s
    mode http

    acl portal path -i -m beg /self
    acl portal path -i -m beg /oauth2/
    acl portal path /vulture_disconnect
    acl portal path -i -m beg /templates/
    acl template path -i -m beg /templates/
    acl favicon path /favicon.ico

    http-request deny deny_status 404 if favicon

    http-request redirect code 307 location {{conf.public_dir}}?redirect_url=%[pathq,url_enc()] if !{ path {{conf.public_dir}} } !portal

    http-request set-path /portal/{{ conf.id }}%[path] unless template
    http-request set-path /portal/{{ conf.id }}/ if METH_POST !portal

    # Use portals' internal proxy load-balancer
    server portals unix@/var/sockets/haproxy/portals.sock
{% endif %}
