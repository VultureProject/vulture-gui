#This file is part of Vulture OS.
#

########################## WARNING ###############################
# Don't edit this file, it is automatically generated by Vulture #
########################## WARNING ###############################


backend portal_{{ conf.id }}
    timeout connect 2s
    timeout server 20s
    mode http

    acl portal path -i -m beg /self
    acl portal path -i -m beg /oauth2/
    acl portal path /vulture_disconnect
    acl portal path -i -m beg /templates/
    acl template path -i -m beg /templates/
    acl cors_enabled var(txn.cors_enable) eq 1

    # Mandatory directives for authentication
    http-request add-header X-Forwarded-Proto http if ! { ssl_fc }
    http-request add-header X-Forwarded-Proto https if { ssl_fc }

    http-request set-var(txn.cors_enable) int(1) if portal
    http-response add-header Access-Control-Allow-Origin "*" if cors_enabled

    http-request set-path /portal/{{ conf.id }}%[path] unless template
    http-request set-path /portal/{{ conf.id }}/ if METH_POST !portal

    # Use portals' internal proxy load-balancer
    server portals unix@/var/sockets/haproxy/portals.sock



