#This file is part of Vulture OS.
#

########################## WARNING ###############################
# Don't edit this file, it is automatically generated by Vulture #
########################## WARNING ###############################


backend portal_{{ conf.id }}
    timeout connect 2s
    timeout server 20s
    mode http

    acl portal path -i -m beg /oauth2/
    acl portal path -i -m beg /templates/
    acl template path -i -m beg /templates/
    errorfile 429 /usr/local/etc/haproxy.d/templates/html_login_{{conf.id}}.html
    http-request deny deny_status 429 if !METH_POST !portal

    http-request set-path /portal/{{ conf.id }}%[path] unless template
    http-request set-path /portal/{{ conf.id }} if METH_POST !portal

    # Load-Balance between cluster nodes
    server srv-portal_{{ conf.id }} portal:9000/{{conf.id}}/ check ssl crt /var/db/pki/node.pem ca-file /var/db/pki/ca.pem
    {% for node in nodes %}
    server srv-portal_{{ node.name }}_{{ conf.id }} {{node.name}}:9000/{{conf.id}}/{{conf.backend.id}}/ check ssl crt {{node.get_certificate().bundle_filename}} ca-file /var/db/pki/ca.pem
    {% endfor %}

