#This file is part of Vulture OS.
#

########################## WARNING ###############################
# Don't edit this file, it is automatically generated by Vulture #
########################## WARNING ###############################


backend idp_{{conf.id}}

    timeout connect 2s
    timeout server 20s
    mode http

    acl fqdn hdr(host) {{conf.external_fqdn}}
    acl fqdn hdr(host) -m beg {{conf.external_fqdn}}:
    acl oauth path /oauth2/token
    acl oauth path /oauth2/authorize
    acl oauth path /oauth2/userinfo
    acl oauth path /.well-known/openid-configuration
    acl self path -i -m beg /{{global_config.public_token}}/self
    acl template path -i -m beg /templates/
    http-request deny deny_status 403 if !fqdn
    http-request deny deny_status 403 if !oauth !template !self

    # Mandatory directives for authentication
    http-request add-header X-Forwarded-Proto http if ! { ssl_fc }
    http-request add-header X-Forwarded-Proto https if { ssl_fc }

    http-request set-path /portal/portal_{{ conf.id }}%[path] if !template !self
    http-request replace-path /{{global_config.public_token}}/(.*) /portal/portal_{{ conf.id }}/\1 if self

    # Use portals' internal proxy load-balancer
    server portals unix@/var/sockets/haproxy/portals.sock



