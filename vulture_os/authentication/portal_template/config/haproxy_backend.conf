#This file is part of Vulture OS.
#

########################## WARNING ###############################
# Don't edit this file, it is automatically generated by Vulture #
########################## WARNING ###############################


backend {{ conf.name }}
    timeout connect 2s
    timeout server 2s
    {% if conf.enabled %}enabled {% else %}disabled {% endif %}
    {% for server in conf.servers -%}
        {{ server.generate_conf() }} {%- if conf.enable_http_health_check %} check {% endif %}
    {%- endfor %}
    mode {{ conf.mode }}
    no log
    {{ conf.custom_haproxy_conf }}
    {% if conf.mode == "http" -%}
        {% for header in conf.headers -%}
            {{ header.generate_conf() }}
        {% endfor %}
        {%- if conf.accept_invalid_http_response -%}
            option accept-invalid-http-request
        {% endif -%}
        {% if conf.http_forwardfor_header != "" and http_forwardfor_except != "" -%}
            option forwardfor {% if conf.http_forwardfor_except != "" %}except {{conf.http_forwardfor_except}} {% endif -%}
            {%- if http_forwardfor_header != "" %}header {{conf.http_forwardfor_header}}{% endif %}
        {% endif %}
        {%- if conf.enable_http_health_check -%}
            option httpchk {{conf.http_health_check_method}} {{conf.http_health_check_uri}} {{conf.http_health_check_version}}
            {%- for key, value in conf.http_health_check_headers.items() -%}
                {{ key }}:\ {{ value }}{%- if not loop.last %}\r\n{% endif %}
            {%- endfor %}
        {% endif -%}
        {% if not conf.enable_http_keep_alive %}no {% endif -%}option http-keep-alive
        {% if conf.enable_http_keep_alive %}timeout http-keep-alive {{ conf.http_keep_alive_timeout }}{% endif %}
    {% endif %}
