#This file is part of Vulture OS.
#

########################## WARNING ###############################
# Don't edit this file, it is automatically generated by Vulture #
########################## WARNING ###############################

{% set darwin_default_calls = {
        "lkup": [{
            "inputs": ["!src_ip"],
            "outputs": ["!src_ip"]
        }],
        "vast": [{
            "inputs": ["!bytes_received"],
            "outputs": ["!bytes_received"]
        }],
        "vaml": [{
            "inputs": ["!bytes_received"],
            "outputs": ["!bytes_received"]
        }]
}-%}

ruleset(name="{{ frontend.ruleset_name }}" queue.workerThreads="{{ frontend.nb_workers }}") {

    set $!frontend_name = "{{frontend.name}}";
    set $!tenants_name = "{{frontend.tenants_config.name}}";

    # This is necessary to ensure presence of dictionary in message
    set $.ret = parse_json("{}", "\$!advens");

    action(type="mmjsonparse" cookie="")

    # If log access
    if $parsesuccess=="OK" then {

        if $!server_port == "-" then {
            set $!server_port = 0;
        } else {
            set $!server_port = cnum($!server_port);
        }
        if $!backend_port == "-" then {
            set $!backend_port = 0;
        } else {
            set $!backend_port = cnum($!backend_port);
        }
        if $!darwin_reputation_error == "-" then {
            set $!darwin_reputation_error = 0;
        } else {
            set $!darwin_reputation_error = cnum($!darwin_reputation_error);
        }
        if $!darwin_session_error == "-" then {
            set $!darwin_session_error = 0;
        } else {
            set $!darwin_session_error = cnum($!darwin_session_error);
        }
        if $!darwin_user_agent_error == "-" then {
            set $!darwin_user_agent_error = 0;
        } else {
            set $!darwin_user_agent_error = cnum($!darwin_user_agent_error);
        }
        if $!darwin_reputation_score == "-" then {
            set $!darwin_reputation_score = -1;
        } else {
            set $!darwin_reputation_score = cnum($!darwin_reputation_score);
        }
        if $!darwin_session_score == "-" then {
            set $!darwin_session_score = -1;
        } else {
            set $!darwin_session_score = cnum($!darwin_session_score);
        }
        if $!darwin_user_agent_score == "-" then {
            set $!darwin_user_agent_score = -1;
        } else {
            set $!darwin_user_agent_score = cnum($!darwin_user_agent_score);
        }

        {% for f_reputation_ctx in frontend.reputation_ctxs %}
        {% if f_reputation_ctx.enabled %}
        action( type="mmdblookup"
                mmdbfile="{{f_reputation_ctx.reputation_ctx.absolute_filename}}"
                fields=["!ctx_tags"]
                key="!{{f_reputation_ctx.arg_field}}"
                cache_size="{{frontend.mmdb_cache_size}}")
        {% endif %}
        {% endfor %}

        {% if frontend.reputation_database_v4 -%}
        action( type="mmdblookup"
                mmdbfile="{{frontend.reputation_database_v4}}"
                fields=["!reputation"]
                key="!src_ip"
                cache_size="{{frontend.mmdb_cache_size}}")
        {%- endif %}
        {% if frontend.reputation_database_v6 -%}
        action( type="mmdblookup"
                mmdbfile="{{frontend.reputation_database_v6}}"
                fields=["!reputation"]
                key="!src_ip"
                cache_size="{{frontend.mmdb_cache_size}}")
        {%- endif %}
        {% if frontend.geoip_database -%}
        action( type="mmdblookup"
                mmdbfile="{{frontend.geoip_database}}"
                fields=["!country"]
                key="!src_ip"
                cache_size="{{frontend.mmdb_cache_size}}")
        {%- endif %}

        set $!frontend_name = "{{frontend.name}}";

        # Convert timestamp from epoch to rfc3339
        set $!timestamp = replace(format_time(field($!time, ".", 1), "date-rfc3339"), "Z", "." & field($!time, ".", 2) & "Z");

        {% include "rsyslog_darwin/ruleset.conf" %}

        {{ frontend.log_condition }}

        stop

    # If other logs
    } else {
        action(type="omfile"
               File="/var/log/haproxy/{{frontend.name}}.log"
               # FIXME : Add dirOwner, dirGroup, fileOwner, fileGroup, dirCreateMode, fileCreateMode
               flushInterval="1"
               asyncWriting="on")
    }
}
