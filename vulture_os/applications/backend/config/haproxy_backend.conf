#This file is part of Vulture OS.
#

########################## WARNING ###############################
# Don't edit this file, it is automatically generated by Vulture #
########################## WARNING ###############################


backend {{ conf.name }}
    {% if conf.enabled %}enabled {% else %}disabled {% endif %}

    mode {{ conf.mode }}

    timeout connect {{conf.timeout_connect}}ms
    timeout server {{conf.timeout_server}}s

    no log

    balance {{conf.balancing}}

    # Custom conf
    {{ conf.custom_haproxy_conf }}

    {% if conf.mode == "http" -%}
    # HTTP Headers
    {% for header in conf.headers -%}
    {% if header.enabled -%}
    {{ header.generate_conf() }}
    {% endif %}
    {%- endfor %}

    {% if conf.accept_invalid_http_response -%}
    option accept-invalid-http-request
    {%- endif %}

    {% if conf.http_forwardfor_header -%}
    # Send request client IP in HTTP header
    option forwardfor {% if conf.http_forwardfor_except %}except {{conf.http_forwardfor_except}}{% endif -%}{% if conf.http_forwardfor_header %}header {{conf.http_forwardfor_header}}{% endif %}
    {%- endif %}

    # HTTP Health check
    {% if conf.enable_http_health_check -%}
    option httpchk {{conf.http_health_check_method}} {{conf.http_health_check_uri}} {{conf.http_health_check_version}}
    {%- for key, value in conf.http_health_check_headers.items() -%}
        {{ key }}:\ {{ value }}{%- if not loop.last %}\r\n{% endif %}
    {%- endfor %}
    {% if conf.http_health_check_expect -%}
    http-check expect {{conf.http_health_check_expect}}
    {%- endif -%}
    {%- endif %}

    # Keep-Alive options
    {% if conf.enable_http_keep_alive -%}
    option http-keep-alive
    timeout http-keep-alive {{ conf.http_keep_alive_timeout }}
    {%- else -%}
    no option http-keep-alive
    {%- endif %}

    {% for acl in conf.access_controls_list %}
    {{ acl }}
    {% endfor %}

    {%- if conf.workflows -%}
    # Workflow ACLs
    {%- for workflow in conf.workflows %}
    acl workflow_{{workflow.id}}_host hdr(host) {{workflow.fqdn}}
    acl workflow_{{workflow.id}}_dir path -i -m beg {{workflow.public_dir}}
    {% endfor %}
    {%- endif %} {# if conf.workflows #}
    {% endif %} {# if mode http #}

    {% for workflow in conf.workflows -%}
    {%- if conf.mode == "http" and workflow.authentication -%}
    # Session verification
    http-request set-var(proc.repo_ids) str("{{ workflow.authentication.repository }}{% for repo in workflow.authentication.repositories_fallback.all().only() %},{{repo.id}}{% endfor %}") if { hdr(host) {{workflow.fqdn}} }
    filter spoe engine session config {{ conf.CONF_PATH }}/spoe_session.txt
    # In case of SPOE error : Return Gateway-Timeout
    http-request deny deny_status 504 if { var(txn.session.error) -m int gt 0 } workflow_{{workflow.id}}_host workflow_{{workflow.id}}_dir
    # Authentication
    use-server portal_{{workflow.id}} if { var(sess.session.ip_score) -m int ne 1 } workflow_{{workflow.id}}_host workflow_{{workflow.id}}_dir
    {%- endif %}
    {% endfor %}

    {% for workflow in conf.workflows -%}
    {%- if workflow.access_controls_deny|length -%}
    {% for acl in workflow.access_controls_deny %}
    {% for condition in acl.conditions %}
    {% if conf.mode == "http" %}http-request deny{% elif conf.mode == "tcp"%}tcp-request connection reject{% endif %} if workflow_{{ workflow.id }}_host workflow_{{ workflow.id }}_dir {{ condition }}
    {% endfor %}
    {%- endfor -%}
    {% endif %}

    {%- if workflow.access_controls_302|length -%}
    {% for acl in workflow.access_controls_302 %}
    {% for condition in acl.conditions %}
    http-request redirect location {{ acl.redirect_url }} code 302 if workflow_{{ workflow.id }}_host workflow_{{ workflow.id }}_dir {{ condition }}
    {% endfor %}
    {%- endfor -%}
    {% endif %}

    {%- if workflow.access_controls_301|length -%}
    {% for acl in workflow.access_controls_301 %}
    {% for condition in acl.conditions %}
    http-request redirect location {{ acl.redirect_url }} code 301 if workflow_{{ workflow.id }}_host workflow_{{ workflow.id }}_dir {{ condition }}
    {% endfor %}
    {%- endfor -%}
    {% endif %}
    {% endfor %}

    {% if conf.mode == "http" and conf.http_backend_dir != "/" -%}
    http-request set-path {{conf.http_backend_dir}}%[path]
    {%- endif %}

    # Servers
    {% for server in conf.servers -%}
        {{ server.generate_conf() }} {%- if conf.enable_http_health_check %} check {% endif %}
    {%- endfor %}

    {% for workflow in conf.workflows -%}
    {% if workflow.authentication %}
    server srv-portal_{{ workflow.id }} portal:8000/{{workflow.id}}/{{workflow.backend.id}}/ check
    {% endif %}
    {% endfor %}
